<?php

/**
 * @file
 * Contains aps_general.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use Drupal\taxonomy\Entity\Term;
use Drupal\taxonomy\Entity\Vocabulary;
use Drupal\user\Entity\User;
use Drupal\Core\Link;
use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\paragraphs\Entity\Paragraph;
use Drupal\Core\StringTranslation\TranslatableMarkup;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\HtmlCommand;
use Drupal\Core\Ajax\InvokeCommand;
use Drupal\Core\Ajax\RemoveCommand;
use Drupal\Component\Datetime\DateTimePlus;
use Drupal\Core\Datetime\DrupalDateTime;
use Drupal\Core\Field\FieldDefinitionInterface;
use Drupal\field\Entity\FieldStorageConfig;
use \Drupal\field\Entity\FieldConfig;


/**
 * Implements hook_help().
 */
function aps_general_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the aps_general module.
    case 'help.page.aps_general':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('General APS Functionality') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function aps_general_theme() {
  return [
    'aps_general' => [
      'render element' => 'children',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function aps_general_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  //Condition for Unit Add form
  if($form_id == 'node_unit_form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_general_unit_page_redirect';
      }
    }
  }

  //Condition for Procedure Add form
  if($form_id == 'node_procedures_form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_general_procedures_page_redirect';
      }
    }
  }
  
  //Condition for Business Add form
  if($form_id == 'node_business_process_form'){
    // $del = Vocabulary::load('gia_tech')->delete();die;
    $form['field_refere']['#access'] = FALSE;
    if($id = \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_business_process_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_business_process_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for Department Add form
  if($form_id == 'node_department_form'){
    $form['field_refere']['#access'] = FALSE;
    if($id = \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      // $vid_to_check = \Drupal::request()->query->get('unit_ref');
      // $properties['vid'] = $vid_to_check;
      // $properties['name'] = 'Location';
      // $parent_term = getTidByName('Location', $vid_to_check);
      // $load_children = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadChildren($parent_term);
      // $term_data['_none'] = '- None -';
      // foreach ($load_children as $term) {
      //  $term_data[$term->get('tid')->value] = $term->get('name')->value;
      // }
      // $config_factory = \Drupal::configFactory();
      // $config = $config_factory->getEditable('field.field.node.department.field_business_head');
      // $config->set('settings.handler_settings.target_bundles.business_head', 'gai_tech');
      // $config->save(TRUE);
      // $form['field_business_head']['widget']['#default_value'] = ['_none'];
      // $form['field_business_head']['widget']['#options'] = $term_data;
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_department_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_department_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for Section Add form
  if($form_id == 'node_section_form'){
    $form['field_refere']['#access'] = FALSE;
    if($unit_ref= \Drupal::request()->query->get('unit_ref')){
      $unit_ref_object = Node::load($unit_ref);
      $unit_refernced_shift = $unit_ref_object->field_shift->getValue();
      foreach ($unit_refernced_shift as $key => $value) {
        $def_values[$value['target_id']] = $value['target_id'];
      }
      $form['field_shift']['widget']['#default_value'] = $def_values;
    }
    if($id= \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_section_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_section_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for External Audit Add form
  if($form_id == 'node_external_audit__form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_ext_audit_page_redirect';
      }
    }
  }

  //Condition for Clauses Add form
  if($form_id == 'node_clauses_form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_clauses_page_redirect';
      }
    }
  }

  //Condition for Assembly Add form
  if($form_id == 'node_assembly_form'){
    $form['field_refere']['#access'] = FALSE;
    if($unit_ref= \Drupal::request()->query->get('unit_ref')){
      $unit_ref_object = Node::load($unit_ref);
      $unit_refernced_shift = $unit_ref_object->field_shift->getValue();
      foreach ($unit_refernced_shift as $key => $value) {
        $def_values[$value['target_id']] = $value['target_id'];
      }
      $form['field_shift']['widget']['#default_value'] = $def_values;
    }
    if($id= \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_assembly_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_assembly_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  if($form_id == 'user_register_form'){
    $form['#title'] = 'Add Roles';
    if($form['account']['roles']){
      $form['account']['roles']['#type'] = 'select';
    }
    if(\Drupal::request()->query->get('type') == 'default'){
      $method = 'aps_assembly_user_redirect_default';
      $form['field_functions']['#access'] = FALSE;
    }
    else{
      $method = 'aps_assembly_user_redirect_auditor';
      $form['field_functions']['#access'] = TRUE;
    }
    
    $form['account']['status']['#access'] = FALSE;
    $form['account']['name']['#weight'] = -1;
    $form['account']['name']['#title'] = t('Name');
    $value = [    
      'value' => NULL,
      'country' => "IN",
      'local_number' => NULL,
      'verified' => NULL,
      'tfa' => NULL,
    ];
    $form['field_phone']['widget'][0]['#default_value'] = $value;
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = $method;
      }
    }
  }

  if($form_id == 'node_customers_manual_edit_form'){
    $form['field_sr_no']['#access'] = FALSE;
    $form['field_version_date']['#access'] = FALSE;
    $form['title']['#access'] = FALSE;
    $form['field_version_level']['#access'] = FALSE;
  }
  elseif ($form_id == 'node_customers_manual_form') {
    $form['field_reference_id']['#access'] = FALSE;
  }

  if($form_id == 'node_external_audit__form' || $form_id == 'node_external_audit__edit_form'){
    $form['field_audit_type']['#access'] = FALSE;
  }
  
  if($form_id == 'customer_manual_parts_parts_form'){
    if($nid = \Drupal::request()->query->get('id')){
      $form['field_reference_id']['widget'][0]['target_id']['#default_value'] = Node::load($nid);
      foreach (array_keys($form['actions']) as $action) {
        if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
          $form['actions'][$action]['#submit'][] = 'parts_redirect';
        }
      }
    }
    $form['field_reference_id']['#access'] = FALSE;
  }
  if($form_id == 'node_business_process_form'){
    $form['field_business_process_efficienc']['widget'][0]['subform']['field_other']['#states'] = [
      'visible' => [
        'select[name="field_business_process_efficienc[0][subform][field_uom]"]' => ['value' => '73']
      ],
    ];

    $form['field_business_process_effective']['widget'][0]['subform']['field_other']['#states'] = [
      'visible' => [
        'select[name="field_business_process_effective[0][subform][field_uom]"]' => ['value' => '73']
      ],
    ];
  }
 
  if($form_id == 'customer_manual_parts_parts_form' || $form_id == 'customer_manual_parts_parts_edit_form'){
    $form['field_add_parts']['widget'][0]['top']['paragraph_type_title']['info']['#markup'] = 'Products';

    $form['field_add_parts']['widget']['add_more']['add_more_button_customer_manual_parts']['#value'] = new TranslatableMarkup("@type", array(
       '@type' => 'Add Product',
    ));
  }

  if($form_id == 'node_internal_audit_form'){

  }
}
/**
 * Implements  hook_entity_insert().
 */
function aps_general_node_insert(Node $node) {
  $node->setPublished(TRUE);
  $node->save();
  if($node->bundle() == 'assembly'){
    $title = $node->get('title')->value;
    $term = Term::create([
      'name' => $title, 
      'vid' => 'assembly_type',
    ])->save();
  }
  if($node->bundle() == 'unit'){
    $title = $node->get('title')->value;
    $field_address = $node->get('field_address')->locality;
    $field_remote_location = $node->get('field_remote_address')->locality;
    
    $vid_to_check = strtolower(preg_replace('/\s+/', '_', $title));
    $vocabularies = \Drupal\taxonomy\Entity\Vocabulary::loadMultiple();
    if(!isset($vocabularies[$vid_to_check])){
      $vocabulary = Vocabulary::create([
        'vid' => $vid_to_check,
        'description' => 'Vocabluary for '.$title,
        'name' => 'Vocabulary for ' .$title,
      ])->save();
    }

    $term = Term::create([
      'name' => 'Location', 
      'vid' => $vid_to_check,
    ]);
    $inserted_or_updated = $term->save();
    $tid = $term->id();

    $term_location = Term::create([
    'name' => $field_address, 
    'vid' => $vid_to_check,
    'parent' => [$tid],
    ]);
    $inserted_or_updated_location = $term_location->save();
    $tid_location = $term_location->id();

    $term_location_remote = Term::create([
      'name' => $field_remote_location, 
      'vid' => $vid_to_check,
      'parent' => [$tid],
    ])->save();

    $config_factory = \Drupal::configFactory();
    $config = $config_factory->getEditable('aps_general.unitregistration');
    $config->set('unit_registered', $node->id());
    $config->save(TRUE);

  }
  if($node->bundle() == 'business_process'){
    $bp_title = $node->get('title')->value;
    $vid_bp = preg_replace('/\s+/', '_', $bp_title);
    //UNit reference
    $unit_id = \Drupal::request()->query->get('id');
    $unit_object = Node::load($unit_id);
    $unit_title = $unit_object->get('title')->value;
    $vid_unit = strtolower(preg_replace('/\s+/', '_', $unit_title));
    $head_name = $node->get('field_business_head_name')->value;
    $term = Term::create([
      'name' => 'Business Process', 
      'vid' => $vid_unit,
    ]);

    $inserted_or_updated = $term->save();
    $tid = $term->id();

    $term = Term::create([
      'name' => $head_name, 
      'vid' => $vid_unit,
      'parent' => [$tid],
    ])->save();
  }
}

/**
 * Implements  hook_entity_presave().
 */
function aps_general_node_presave(Node $node) {
 if($node->bundle() == 'planned_events'){
    if($suggested_date = $node->get('field_suggested_date')->value){
      $current_user = \Drupal::currentUser();
      $roles = $current_user->getRoles();
      $user_timezone =  drupal_get_user_timezone();
      $get_current_timestamp = getCurrentTimestamp($user_timezone);
      if(in_array('auditor', $roles)){
        $notifictaion_insert = \Drupal::database()->insert('notifications');
        $message = 'Reschedule the audit to '.$suggested_date;
        $notifictaion_insert->fields([
          'nid' => $node->id(),
          'uid' => $current_user->id(),
          'message' => $message,
          'timestamp' => $get_current_timestamp,
          'status' => 0,
        ]);
        $notifictaion_insert->execute();
      }
    }
  }
}

/**
 * Implements  hook_entity_create().
 */
function aps_general_node_create(Node $entity) {
  if ($entity->bundle() == 'procedures') {
    $config = \Drupal::service('config.factory')->getEditable('aps_general.adduserroles');
    $current_count = $config->get('current_count');
    if($current_count == 0){
      $count = $config->get('default_count');
    }
    elseif ($current_count > 0) {
      $count = $config->get('current_count');
    }
    if($entity->isNew()){
      $paragraph = Paragraph::create([
        'field_s_no' => $count,
        'type' => 'procedures',
      ]);
      $paragraph->save();
      $paragraphp_version = [
        [
          'target_id' => $paragraph->id(),
          'target_revision_id' => $paragraph->getRevisionId(),
        ],
      ];
      $entity->set('field_create_procedure', $paragraphp_version);
      $config->set('previous_count', $count);
      $config->set('current_count', $count + 1);
      $config->save();
    }
  }
}

/**
 * Implements  hook_preprocess_page().
 */
function aps_general_preprocess_page(&$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof  \Drupal\node\NodeInterface) {
    $nid_type = $node->bundle();
  }
  if($route_name == 'view.customer_manual_parts.product_listing'){
    //*** Rendering parts block ***//
    $view = \Drupal\views\Views::getView('customer_manual_parts');
    $view->setDisplay('parts');
    $title = $view->getTitle();
    $render = $view->render();
    $the_title_render_array = [
      '#markup' => '<h1>'.$title.'</h1>',
      '#allowed_tags' => ['h1'],
    ];

    //*** Rendering CSv Block ***//
    $block_manager = \Drupal::service('plugin.manager.block');
    $config = [];
    $plugin_block = $block_manager->createInstance('csv_import_block', $config);
    $render_csv = $plugin_block->build();
    $variables['page']['content']['csv'] = $render_csv;
    // kint($variables['page']['content']['csv']['entity_upload']);
    
    // $variables['page']['content'][] = $the_title_render_array;
    // $variables['page']['content']['parts'] = $render;
  }
}

/**
 * Implements  hook_menu_local_tasks_alter().
 */
function aps_general_menu_local_tasks_alter(&$data, $route_name, $root_path) {
  $current_uri = trim(\Drupal::request()->getRequestUri(), '/');
  $uri = explode('/', $current_uri);
  if(isset($uri[2])){
    if ($uri[2] == 'external_audit_') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs'][0]['aps_audit_criteria.audit_list']);
        unset($data['tabs'][0]['aps_audit_criteria.systems_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
      }
    }
    if ($uri[2] == 'clauses') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs'][0]['aps_audit_criteria.audit_list']);
        unset($data['tabs'][0]['aps_audit_criteria.systems_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
      }
    }
    elseif ($uri[2] == 'unit') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs']);
      }
    }
    elseif ($uri[2] == 'department') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs']);
      }
    }
     elseif (stripos(strtolower($uri[2]), 'department?') !== false) {
        unset($data['tabs']);
    }
     elseif (stripos(strtolower($uri[2]), 'business_process?') !== false) {
        unset($data['tabs']);
    }
    elseif ($uri[2] == 'internal_audit') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs'][0]['aps_general.standards']);
        unset($data['tabs'][0]['aps_general.clauses']); 
        unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
        unset($data['tabs'][0]['aps_pre_audit.manuals:3']);
        unset($data['tabs'][0]['aps_general.manual']);
        unset($data['tabs'][0]['aps_general.manual_product']);
      }
    }
    elseif (stripos(strtolower($uri[2]), 'planned_events?') !== false) {
        unset($data['tabs']);
    }
    elseif ($uri[2] == 'customers_manual?destination=node') {
        unset($data['tabs'][0]['aps_general.standards']);
        unset($data['tabs'][0]['aps_general.clauses']); 
        unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.audit_list']);
        unset($data['tabs'][0]['aps_audit_criteria.systems_setting']);
        unset($data['tabs'][0]['aps_pre_audit.manuals:3']);
    }
    elseif ($uri[2] == 'customers_manual') {
        unset($data['tabs']);
    }
    elseif (stripos(strtolower($uri[2]), 'section?') !== false) {
        unset($data['tabs']);
    }
    elseif (stripos(strtolower($uri[2]), 'assembly?') !== false) {
        unset($data['tabs']);
    }
    elseif (stripos(strtolower($uri[2]), 'internal_documents?') !== false) {
        unset($data['tabs']);
    }
    elseif (stripos(strtolower($uri[2]), 'pre_audit_records?') !== false) {
        unset($data['tabs']);
    }
    elseif (stripos(strtolower($uri[2]), 'pre_audit_manuals?') !== false) {
        unset($data['tabs']);
    }
    elseif ($uri[2] == 'procedures') {
      unset($data['tabs'][0]['aps_general.manual']);
      unset($data['tabs'][0]['aps_general.manual_product']);  
      unset($data['tabs'][0]['aps_general.clauses']); 
      unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
      unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
      unset($data['tabs'][0]['aps_audit_criteria.audit_list']);
      unset($data['tabs'][0]['aps_audit_criteria.systems_setting']);
      $data['tabs'][0]['aps_general.standards']['#link']['title'] = 'Procedure Listing';
      $data['tabs'][0]['aps_general.standards']['#link']['url'] = Url::fromUserInput('/procedure-listing');
    }
  }

  if($uri[0] = 'audit_criteria' && $uri[2] = 'edit'){
    $data['tabs'][0]['aps_general.process_setting']['#link']['url'] = Url::fromUserInput('/audit_criteria_process/1/edit');
    $data['tabs'][0]['aps_general.product_setting']['#link']['url'] = Url::fromUserInput('/audit_criteria_product/1/edit');
  }
  if ($current_uri == 'audit_criteria/1/edit') {
    $data['tabs'][0]['eck.entity_content:audit_criteria.eck_edit_tab']['#link']['title'] = 'Systems';
    unset($data['tabs'][0]['aps_general.systems_setting']);
  }
  if($current_uri == 'internal-audit-list'){
    unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
    unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
  }
  if($route_name == 'view.planned_audit_listing.document_list_ia'){
    $config = \Drupal::service('config.factory')->getEditable('aps_general.adduserroles');
    if($config->get('doc_id')){
      $id = $config->get('doc_id');
    }
    $data['tabs'][0]['aps_pre_audit.manuals:2']['#link']['url']->setRouteParameters(['arg_0' => $id]);
  }
}

/**
 * Implements  hook_entity_insert().
 */
function aps_general_user_insert(User $user) {
  if(\Drupal::request()->query->get('type') == 'auditor'){
    $user->addRole('auditor');
    $user->save();
  }
}

/**
 * Implements hook_views_query_alter().
 */
function aps_general_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if($view->id() === 'registered_unit_listing'){
    $config_factory = \Drupal::configFactory();
    $config = $config_factory->getEditable('aps_general.unitregistration');
    $registered_unit = $config->get('unit_registered');
    if($view->getDisplay()->display['id'] == 'bp'){
      $definition = [
        'table' => 'node__field_refere',
        'field' => 'entity_id',
        'left_table' => 'node_field_data',
        'left_field' => 'nid',
      ];
      $join = Drupal::service('plugin.manager.views.join')->createInstance('standard', $definition);
      $query->addRelationship('node__field_refere', $join, 'node');
      $query->addWhere('AND', 'node__field_refere.bundle', 'business_process');
      $query->addWhere('AND', 'node__field_refere.field_refere_target_id', $registered_unit);
    }
    if($view->getDisplay()->display['id'] == 'section_list'){
      $config_factory = \Drupal::configFactory();
      $config = $config_factory->getEditable('aps_general.unitregistration');
      $registered_unit = $config->get('unit_registered');
      $definition = [
        'table' => 'node__field_refere',
        'field' => 'entity_id',
        'left_table' => 'node_field_data',
        'left_field' => 'nid',
      ];
      $join = Drupal::service('plugin.manager.views.join')->createInstance('standard', $definition);
      $query->addRelationship('node__field_refere', $join, 'node');
      $query->addWhere('AND', 'node__field_refere.field_refere_target_id', $registered_unit);
      $query->addWhere('AND', 'node__field_refere.bundle', 'section');
    }
  }
}

function aps_general_views_pre_render(ViewExecutable $view) {
}

/**
 * Implements hook_link_alter().
 */
function aps_general_link_alter(&$variables) { 
  $route_name = \Drupal::routeMatch()->getRouteName();
  $node = \Drupal::routeMatch()->getParameter('node');
  $current_uri = trim(\Drupal::request()->getRequestUri(), '/');
  $uri = explode('/', $current_uri);
  if ($node instanceof \Drupal\node\NodeInterface) {
    $nid_type = $node->bundle();
  }
  if($route_name == 'entity.node.edit_form' && $nid_type == 'customers_manual'){
    $linkText = $variables['text'];
    $cleanLinkText = rtrim(strip_tags($linkText));
    if ($cleanLinkText == 'Add Manual Parts') {
      $variables['options']['query'] = ['id' => $node->id()];
    }
  }

  if ($route_name == 'view.planned_audit_listing.page_1') {
    $config = \Drupal::service('config.factory')->getEditable('aps_pre_audit.getmoreinfo');
    $linkText = $variables['text'];
    $cleanLinkText = rtrim(strip_tags($linkText));
    if ($cleanLinkText == 'Documents') {
      $get_nid = explode('?', $uri[1]);
      $url = Url::fromRoute('view.planned_audit_listing.document_list_ia',['arg_0' => $get_nid[0]]);
      unset($variables['url']);
      $variables['url'] = $url;
      $config->set('nid', $get_nid[0])->save();
    }
  }
  $linkText = $variables['text'];
  $cleanLinkText = rtrim(strip_tags($linkText));
  if ($cleanLinkText == 'Notification') {
    $query = \Drupal::database()->select('notifications', 'n');
    $query->fields('n');
    $nids = $query->execute()->fetchAll();
    $count = count($nids);
    $title = new TranslatableMarkup("@text", array(
       '@text' => 'Notification'.'('.$count.')',
    ));
    $variables['text'] = $title;
  }
  
}

function get_user_roles(){
  $roles = user_role_names(TRUE);
  return $roles;
}

function test(){
 $form['field_business_process_efficienc']['widget'][0]['subform']['field_other']['widget']['#access'] = TRUE;
 return $form['field_business_process_efficienc'];
}
/**
 * Callback method after unit form submits.
 */
function aps_general_unit_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/unit-registration-view');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after business process form submits.
 */
function aps_business_process_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $id = \Drupal::request()->query->get('id');
  $node_object = Node::load($id);
  $title = $node_object->get('title')->value;
  $vid_to_check = strtolower(preg_replace('/\s+/', '_', $title));
  $form_values = $form_state->getValues();
  $nid = $form_values['nid'];
  $response = Url::fromUserInput('/node/add/department?id='.$nid.'&unit_ref='.$id.'&business_ref='.$nid);
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after department form submits.
 */
function aps_department_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $business_id = \Drupal::request()->query->get('id');
  $unit_ref = \Drupal::request()->query->get('unit_ref');
  $business_ref = \Drupal::request()->query->get('business_ref');
  $form_values = $form_state->getValues();
  $nid = $form_values['nid'];
  if($business_ref == ''){
    $response = Url::fromUserInput('/node/add/section?id='.$nid.'&unit_ref='.$unit_ref);
  }
  else{
    $response = Url::fromUserInput('/node/add/section?id='.$nid.'&unit_ref='.$unit_ref.'&business_ref='.$business_ref);
  } 
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after department form submits.
 */
function aps_section_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $unit_ref = \Drupal::request()->query->get('unit_ref');
  $form_values = $form_state->getValues();
  $nid = $form_values['nid'];
  $response = Url::fromUserInput('/node/add/assembly?id='.$nid.'&unit_ref='.$unit_ref);
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after assembly form submits.
 */
function aps_assembly_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/unit-registration-view');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after user form submits.
 */
function aps_assembly_user_redirect_default(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/user-listing-all');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after user form submits.
 */
function aps_assembly_user_redirect_auditor(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/user-listing-auditor');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after procedure form submits.
 */
function aps_general_procedures_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after Ext. Audit form submits.
 */
function aps_ext_audit_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/external-audit-standards');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after Clauses form submits.
 */
function aps_clauses_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/external-audit-standards');
  $form_state->setRedirectUrl($response);
}

function parts_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/node/add/customers_manual');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback to get Current timestamp.
 */
function getCurrentTimestamp($user_timezone){
  $db_timezone = 'UTC';
  $get_current_timestamp =  \Drupal::time()->getCurrentTime();
  $current_date_object = DateTimePlus::createFromTimestamp($get_current_timestamp, $db_timezone);
  $current_date_object->setTimezone(new \DateTimeZone($user_timezone));
  return $current_date_object->getTimestamp();
}

function getTidByName($name = NULL, $vid = NULL) {
  $properties = [];
  if (!empty($name)) {
    $properties['name'] = $name;
  }
  if (!empty($vid)) {
    $properties['vid'] = $vid;
  }
  $terms = \Drupal::entityManager()->getStorage('taxonomy_term')->loadByProperties($properties);
  $term = reset($terms);

  return !empty($term) ? $term->id() : 0;
}