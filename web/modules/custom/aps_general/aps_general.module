<?php

/**
 * @file
 * Contains aps_general.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use Drupal\taxonomy\Entity\Term;
use Drupal\user\Entity\User;
use Drupal\Core\Link;

/**
 * Implements hook_help().
 */
function aps_general_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the aps_general module.
    case 'help.page.aps_general':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('General APS Functionality') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function aps_general_theme() {
  return [
    'aps_general' => [
      'render element' => 'children',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function aps_general_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  //Condition for Unit Add form
  // if($form_id == 'node_unit_form'){
  //   foreach (array_keys($form['actions']) as $action) {
  //     if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
  //       $form['actions'][$action]['#submit'][] = 'aps_general_unit_page_redirect';
  //     }
  //   }
  // }

  //Condition for Procedure Add form
  if($form_id == 'node_procedures_form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_general_procedures_page_redirect';
      }
    }
  }
  
  //Condition for Business Add form
  if($form_id == 'node_business_process_form'){
    $form['field_refere']['#access'] = FALSE;
    if($id = \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_business_process_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_business_process_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for Department Add form
  if($form_id == 'node_department_form'){
    $form['field_refere']['#access'] = FALSE;
    if($id = \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_department_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_department_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for Section Add form
  if($form_id == 'node_section_form'){
    $form['field_refere']['#access'] = FALSE;
    if($id= \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_section_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_section_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  //Condition for External Audit Add form
  if($form_id == 'node_external_audit__form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_ext_audit_page_redirect';
      }
    }
  }

  //Condition for Clauses Add form
  if($form_id == 'node_clauses_form'){
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_clauses_page_redirect';
      }
    }
  }

  //Condition for Assembly Add form
  if($form_id == 'node_assembly_form'){
    $form['field_refere']['#access'] = FALSE;
    if($id= \Drupal::request()->query->get('id')){
      $node_object = Node::load($id);
      $form['field_refere']['widget'][0]['target_id']['#default_value'] = $node_object;
    }
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_assembly_page_redirect';
      }
    }
  }
  elseif ($form_id == 'node_assembly_edit_form') {//Edit form
    $form['field_refere']['#access'] = FALSE;
  }

  if($form_id == 'user_register_form'){
    if(\Drupal::request()->query->get('type') == 'default'){
      $form['field_functions']['#access'] = FALSE;
    }
    else{
      $form['field_functions']['#access'] = TRUE;
    }
    
    $form['account']['status']['#access'] = FALSE;
    $form['account']['name']['#weight'] = -1;
    $form['account']['name']['#title'] = t('Name');
    $value = [    
      'value' => NULL,
      'country' => "IN",
      'local_number' => NULL,
      'verified' => NULL,
      'tfa' => NULL,
    ];
    $form['field_phone']['widget'][0]['#default_value'] = $value;
    foreach (array_keys($form['actions']) as $action) {
      if ($action != 'preview' && isset($form['actions'][$action]['#type']) && $form['actions'][$action]['#type'] === 'submit') {
        $form['actions'][$action]['#submit'][] = 'aps_assembly_user_redirect';
      }
    }
  }

  if($form_id == 'node_customers_manual_edit_form'){
    $form['field_sr_no']['#access'] = FALSE;
    $form['field_version_date']['#access'] = FALSE;
    $form['title']['#access'] = FALSE;
    $form['field_version_level']['#access'] = FALSE;
  }

}

/**
 * Implements  hook_entity_insert().
 */
function aps_general_node_insert(Node $node) {
  $node->setPublished(TRUE);
  $node->save();
  if($node->bundle() == 'assembly'){
    $title = $node->get('title')->value;
    $term = Term::create([
      'name' => $title, 
      'vid' => 'assembly_type',
    ])->save();
  }
}

/**
 * Implements  hook_preprocess_page().
 */
function aps_general_preprocess_page(&$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof \Drupal\node\NodeInterface) {
    $nid_type = $node->bundle();
  }
  if($route_name == 'entity.node.edit_form' && $nid_type == 'customers_manual'){
    //*** Rendering parts block ***//
    $view = \Drupal\views\Views::getView('customer_manual_parts');
    $view->setDisplay('parts');
    $title = $view->getTitle();
    $render = $view->render();
    $the_title_render_array = [
      '#markup' => '<h1>'.$title.'</h1>',
      '#allowed_tags' => ['h1'],
    ];

    //*** Rendering CSv Block ***//
    $block_manager = \Drupal::service('plugin.manager.block');
    $config = [];
    $plugin_block = $block_manager->createInstance('csv_import_block', $config);
    $render_csv = $plugin_block->build();
    $variables['page']['content']['csv'] = $render_csv;
    
    $variables['page']['content']['parts'] = $the_title_render_array;
    $variables['page']['content']['parts']['add_new'] = '<a href="/admin/content/customer_manual_parts/add/parts">Add New</a>';
    $variables['page']['content']['parts'] = $render;
  }
}

/**
 * Implements  hook_menu_local_tasks_alter().
 */
function aps_general_menu_local_tasks_alter(&$data, $route_name, $root_path) {
  $current_uri = trim(\Drupal::request()->getRequestUri(), '/');
  $uri = explode('/', $current_uri);
  if(isset($uri[2])){
    if ($uri[2] == 'external_audit_') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs']);
      }
    }
    elseif ($uri[2] == 'unit') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs']);
      }
    }
    elseif ($uri[2] == 'internal_audit') {
      $link = Url::fromUserInput('/node/add/'.$uri[2]);
      if ($link) {
        unset($data['tabs'][0]['aps_general.standards']);
        unset($data['tabs'][0]['aps_general.clauses']); 
        unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
        unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
      }
    }
    elseif ($uri[2] == 'customers_manual') {
        unset($data['tabs']);
    }
  }
  if ($current_uri == 'audit_criteria/1/edit') {
    $data['tabs'][0]['eck.entity_content:audit_criteria.eck_edit_tab']['#link']['title'] = 'Systems';
    unset($data['tabs'][0]['aps_general.systems_setting']);
  }
  if($current_uri == 'internal-audit-list'){
    unset($data['tabs'][0]['aps_audit_criteria.process_setting']);
    unset($data['tabs'][0]['aps_audit_criteria.product_setting']);
  }
}

/**
 * Implements  hook_entity_insert().
 */
function aps_general_user_insert(User $user) {
  if(\Drupal::request()->query->get('type') == 'auditor'){
    $user->addRole('auditor');
    $user->save();
  }
}


/**
 * Callback method after unit form submits.
 */
function aps_general_unit_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/unit-registration-view');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after business process form submits.
 */
function aps_business_process_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/business-process-listing-view');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after department form submits.
 */
function aps_department_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $form_values = $form_state->getValues();
  $nid = $form_values['nid'];
  $response = Url::fromUserInput('/node/add/section?id='.$nid);
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after department form submits.
 */
function aps_section_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $form_values = $form_state->getValues();
  $nid = $form_values['nid'];
  $response = Url::fromUserInput('/node/add/assembly?id='.$nid);
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after assembly form submits.
 */
function aps_assembly_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/unit-registration-view');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after user form submits.
 */
function aps_assembly_user_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/user-listing');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after procedure form submits.
 */
function aps_general_procedures_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after Ext. Audit form submits.
 */
function aps_ext_audit_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/external-audit-standards');
  $form_state->setRedirectUrl($response);
}

/**
 * Callback method after Clauses form submits.
 */
function aps_clauses_page_redirect(array $form, \Drupal\Core\Form\FormStateInterface $form_state){
  $response = Url::fromUserInput('/external-audit-standards');
  $form_state->setRedirectUrl($response);
}